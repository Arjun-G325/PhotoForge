function doResize(e) {
    if (!isResizing) return;
    
    e.preventDefault();
    e.stopPropagation();
    
    const dx = e.clientX - startX;
    const dy = e.clientY - startY;
    
    let newWidth = startWidth;
    let newHeight = startHeight;
    let newLeft = startLeft;
    let newTop = startTop;
    
    const maintainAspect = e.shiftKey;
    const aspectRatio = resizeHandles.aspectRatio;
    
    switch(resizeDirection) {
        case 'nw':
            newWidth = Math.max(50, startWidth - dx);
            if (maintainAspect) newHeight = newWidth / aspectRatio;
            else newHeight = Math.max(50, startHeight - dy);
            newLeft = startLeft + (startWidth - newWidth);
            newTop = startTop + (startHeight - newHeight);
            break;
        case 'ne':
            newWidth = Math.max(50, startWidth + dx);
            if (maintainAspect) newHeight = newWidth / aspectRatio;
            else newHeight = Math.max(50, startHeight - dy);
            newTop = startTop + (startHeight - newHeight);
            break;
        case 'sw':
            newWidth = Math.max(50, startWidth - dx);
            if (maintainAspect) newHeight = newWidth / aspectRatio;
            else newHeight = Math.max(50, startHeight + dy);
            newLeft = startLeft + (startWidth - newWidth);
            break;
        case 'se':
            newWidth = Math.max(50, startWidth + dx);
            if (maintainAspect) newHeight = newWidth / aspectRatio;
            else newHeight = Math.max(50, startHeight + dy);
            break;
    }
    
    // Resize the image
    selectedImage.style.width = newWidth + 'px';
    selectedImage.style.height = newHeight + 'px';
    selectedImage.style.left = newLeft + 'px';
    selectedImage.style.top = newTop + 'px';
    
    // Resize the drawing canvas
    const drawingCanvas = selectedImage.nextElementSibling;
    if (drawingCanvas && drawingCanvas.classList.contains('drawing-canvas')) {
        // Save current drawing context settings
        const currentStrokeStyle = currentDrawingCtx.strokeStyle;
        const currentLineWidth = currentDrawingCtx.lineWidth;
        const currentLineJoin = currentDrawingCtx.lineJoin;
        const currentLineCap = currentDrawingCtx.lineCap;
        
        // Calculate scale factors
        const scaleX = newWidth / startWidth;
        const scaleY = newHeight / startHeight;
        
        // Create a temporary canvas to preserve the drawing
        const tempCanvas = document.createElement('canvas');
        const tempCtx = tempCanvas.getContext('2d');
        tempCanvas.width = drawingCanvas.width;
        tempCanvas.height = drawingCanvas.height;
        tempCtx.drawImage(drawingCanvas, 0, 0);
        
        // Resize the drawing canvas
        drawingCanvas.width = newWidth;
        drawingCanvas.height = newHeight;
        const ctx = drawingCanvas.getContext('2d');
        
        // Clear and redraw with proper scaling
        ctx.clearRect(0, 0, newWidth, newHeight);
        ctx.drawImage(tempCanvas, 0, 0, tempCanvas.width, tempCanvas.height, 
                      0, 0, newWidth, newHeight);
        
        // Restore drawing context settings
        ctx.strokeStyle = currentStrokeStyle;
        ctx.lineWidth = currentLineWidth;
        ctx.lineJoin = currentLineJoin;
        ctx.lineCap = currentLineCap;
        currentDrawingCtx = ctx;
        
        // Update drawing canvas position and size
        drawingCanvas.style.width = newWidth + 'px';
        drawingCanvas.style.height = newHeight + 'px';
        drawingCanvas.style.left = newLeft + 'px';
        drawingCanvas.style.top = newTop + 'px';
        
        // Update brush size to maintain relative size
        if (currentDrawingCtx) {
            currentDrawingCtx.lineWidth = brushSize * Math.min(scaleX, scaleY);
        }
    }
    
    // Update handles container
    const container = document.querySelector('.resize-handles-container');
    if (container) {
        container.style.left = newLeft + 'px';
        container.style.top = newTop + 'px';
        container.style.width = newWidth + 'px';
        container.style.height = newHeight + 'px';
    }
}
